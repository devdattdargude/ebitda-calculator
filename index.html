<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EBITDA Calculator V4</title>
    <link rel="stylesheet" href="src/ui/styles/calculator.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>EBITDA Calculator V4</h1>
        
        <div class="card">
            <h2>Controls</h2>
            <label for="roleSelect">Role</label>
            <select id="roleSelect">
                <option value="viewer">Viewer</option>
                <option value="analyst">Analyst</option>
                <option value="admin">Admin</option>
            </select>
            <button id="lockToggle">Toggle Formula Lock</button>
            
            <h3>User Login</h3>
            <input id="userNameInput"
                   placeholder="Enter user name">
            <button onclick="loginUser()">
                Login
            </button>
            
            <h3>Cloud Sync</h3>
            <button onclick="pushSync()">
                Push to Cloud
            </button>
            <button onclick="pullSync()">
                Pull from Cloud
            </button>
            
            <h3>Approval Workflow</h3>
            <textarea id="approvalComment"
                      placeholder="Approval comment"></textarea>
            <button onclick="submitScenario()">Submit</button>
            <button onclick="approveScenario()">Approve</button>
            <button onclick="rejectScenario()">Reject</button>
            <div id="statusLabel"></div>
            
            <h3>Excel Import</h3>
            <input type="file"
                   id="excelFile"
                   accept=".xlsx,.xls" />
            <button onclick="importExcel()">
                Import Scenario
            </button>
            <button onclick="downloadTemplate()">
                Download Template
            </button>
        </div>
        
        <div class="card">
            <h2>Inputs</h2>
            
            <label for="scenarioName">Scenario Name</label>
            <input id="scenarioName" type="text" placeholder="Enter scenario name">
            
            <label for="propertySelect">Property</label>
            <select id="propertySelect"></select>
            
            <label for="revenue">Revenue</label>
            <input id="revenue" type="number" placeholder="Enter revenue">
            <div class="error" id="revenue_error"></div>
            
            <label for="opex">Operating Expenses</label>
            <input id="opex" type="number" placeholder="Enter operating expenses">
            <div class="error" id="opex_error"></div>
            
            <label for="salary">Salaries</label>
            <input id="salary" type="number" placeholder="Enter salaries">
            <div class="error" id="salary_error"></div>
            
            <label for="cogs">Cost of Goods Sold</label>
            <input id="cogs" type="number" placeholder="Enter COGS">
            <div class="error" id="cogs_error"></div>
            
            <label for="variableCosts">Variable Costs</label>
            <input id="variableCosts" type="number" placeholder="Enter variable costs">
            <div class="error" id="variableCosts_error"></div>
            
            <label for="fixedCosts">Fixed Costs</label>
            <input id="fixedCosts" type="number" placeholder="Enter fixed costs">
            <div class="error" id="fixedCosts_error"></div>
            
            <label for="beds">Beds</label>
            <input id="beds" type="number" placeholder="Enter number of beds">
            <div class="error" id="beds_error"></div>
            
            <label for="seats">Seats</label>
            <input id="seats" type="number" placeholder="Enter number of seats">
            <div class="error" id="seats_error"></div>
            
            <button onclick="runCalc()">Calculate</button>
            <button onclick="CalculatorController.resetAll()">Reset</button>
        </div>
        
        <div class="card result">
            <h2>Results</h2>
            <p>EBITDA: <span id="ebitda">0</span></p>
            <p>EBITDA Margin: <span id="ebitdaMargin">0</span>%</p>
            <p>Gross Margin: <span id="grossMargin">0</span>%</p>
            <p>CM1: <span id="cm1">0</span></p>
            <p>CM2: <span id="cm2">0</span></p>
            <p>Operating Profit: <span id="operatingProfit">0</span></p>
            <p>Per Bed EBITDA: <span id="perBed">0</span></p>
            <p>Per Seat EBITDA: <span id="perSeat">0</span></p>
        </div>
        
        <div class="card">
            <h3>Saved Scenarios</h3>
            <div id="historyBox"></div>
            <button onclick="renderHistory('historyBox')">Refresh History</button>
            <button onclick="exportCSV()">Export CSV</button>
        </div>
        
        <div class="card">
            <h3>Portfolio EBITDA</h3>
            <div id="portfolioBox"></div>
            <button onclick="renderPortfolio()">Refresh Portfolio</button>
        </div>
        
        <div class="card">
            <h3>Dashboard</h3>
            <div>Total Scenarios: <span id="scenarioCount"></span></div>
            <div>Average EBITDA: <span id="avgEbitda"></span></div>
            <div id="auditPanel"></div>
            <canvas id="trendChart"></canvas>
            <canvas id="propertyChart"></canvas>
            <button onclick="renderCharts()">Refresh Charts</button>
        </div>
        
        <div class="card">
            <h3>Scenario Timeline</h3>
            <select id="versionSelect"></select>
            <button onclick="showVersionDiff()">Compare Last Two</button>
            <div id="diffOutput"></div>
            <canvas id="compareChart"></canvas>
        </div>
    </div>
    
    <script type="module">
import { CalculatorController } from "./src/controllers/calculator.js";
import { renderHistory } from "../src/services/history-view.js";
import { exportCSV } from "../src/services/export.js";
import { PropertyRegistry } from "../src/services/property-registry.js";
import { PortfolioService } from "../src/services/portfolio.js";
import { DashboardService } from "../src/services/dashboard.js";
import {
  renderTrendChart,
  renderPropertyChart
} from "./src/ui/dashboard-ui.js";
import { bindRoleSelector } from "./src/ui/role-ui.js";
import { FormulaLock } from "../src/services/formula-lock.js";
import { RoleService } from "../src/services/role-service.js";
import { UserService } from "../src/services/user-service.js";
import { SyncService } from "../src/services/sync-service.js";
import { ApprovalService } from "../src/services/approval-service.js";
import { importExcelFile } from "./src/controllers/import-controller.js";
import { downloadTemplate } from "../src/services/template-export.js";
import {
  loadTimeline,
  renderDiff
} from "./src/ui/audit-ui.js";

window.renderHistory = renderHistory;
window.exportCSV = exportCSV;
window.downloadTemplate = downloadTemplate;
window.loadTimeline = loadTimeline;
window.showVersionDiff = () => renderDiff(activeScenarioId);

window.loginUser = () => {
  const n = userNameInput.value.trim();
  if (!n) return alert("Enter name");

  UserService.login(n);
};

window.pushSync = () => SyncService.pushAll();
window.pullSync = () => SyncService.pullAll();

window.submitScenario = () =>
  ApprovalService.submit(activeScenarioId);

window.approveScenario = () => {

  if (!RoleService.isAdmin())
    return alert("Admin only");

  ApprovalService.approve(
    activeScenarioId,
    UserService.currentUser.id,
    approvalComment.value
  );
};

window.rejectScenario = () => {

  if (!RoleService.isAdmin())
    return alert("Admin only");

  ApprovalService.reject(
    activeScenarioId,
    UserService.currentUser.id,
    approvalComment.value
  );
};

window.renderCharts = function () {
  renderTrendChart("trendChart");
  renderPropertyChart("propertyChart");
  scenarioCount.innerText = DashboardService.count();
  avgEbitda.innerText = DashboardService.averageEBITDA().toFixed(2);
};

window.renderPortfolio = function () {

  const totals = PortfolioService.totals();
  const byProp = PortfolioService.byProperty();

  portfolioBox.innerHTML =
    `<b>Total EBITDA:</b> ${totals.ebitda.toFixed(2)}<br>` +
    Object.entries(byProp)
      .map(([p,v]) => `${p}: ${v.toFixed(2)}`)
      .join("<br>");
};

window.showAudit = function(s) {
  auditPanel.innerText =
    `${s.audit.role} | ${s.audit.savedAt}`;
};

window.importExcel = () => {

  const f =
    document.getElementById("excelFile")
      .files[0];

  if (!f) return alert("Select file");

  importExcelFile(f);
};

function loadProperties() {
  propertySelect.innerHTML =
    PropertyRegistry.getAll()
      .map(p => `<option>${p}</option>`)
      .join("");
}

loadProperties();

bindRoleSelector("roleSelect");

if (RoleService.isViewer()) {
  document
    .querySelectorAll("button")
    .forEach(b => b.disabled = true);
}

lockToggle.onclick = () => {

  if (!RoleService.isAdmin()) {
    alert("Only admin can unlock formulas");
    return;
  }

  FormulaLock.toggle();
};

window.runCalc = () => {

  const data = {
    revenue: revenue.value,
    opex: opex.value,
    salary: salary.value,
    cogs: cogs.value,
    variableCosts: variableCosts.value,
    fixedCosts: fixedCosts.value,
    beds: beds.value,
    seats: seats.value
  };

  const errors = CalculatorController.validateAll(data);

  if (Object.keys(errors).length > 0) {
    alert(Object.values(errors).join("\n"));
    return;
  }

  const r = CalculatorController.calculateAll(data);

  ebitda.innerText = r.ebitda.toFixed(2);
  ebitdaMargin.innerText = r.ebitdaMargin.toFixed(2);
  grossMargin.innerText = r.grossMargin.toFixed(2);
  cm1.innerText = r.cm1.toFixed(2);
  cm2.innerText = r.cm2.toFixed(2);
  operatingProfit.innerText = r.operatingProfit.toFixed(2);
  perBed.innerText = r.perBed.toFixed(2);
  perSeat.innerText = r.perSeat.toFixed(2);

  CalculatorController.saveRun(
    scenarioName.value || "Scenario",
    data,
    r,
    propertySelect.value
  );

  renderCharts();
};
</script>
</body>
</html>
