<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tribe Finance OS | EBITDA & Revenue Share Calculator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #1a365d;
            --secondary-color: #2d74da;
            --accent-color: #0d9b6c;
            --warning-color: #d45a0b;
            --danger-color: #c53030;
            --light-bg: #f7fafc;
            --border-color: #e2e8f0;
            --text-dark: #2d3748;
            --text-light: #718096;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light-bg);
            color: var(--text-dark);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            border-left: 5px solid var(--primary-color);
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            background-color: var(--primary-color);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .logo h1 {
            font-size: 28px;
            color: var(--primary-color);
        }
        
        .logo span {
            color: var(--secondary-color);
        }
        
        .subtitle {
            color: var(--text-light);
            font-size: 16px;
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
        }
        
        .finance-model {
            font-size: 14px;
            background-color: #e6f7ff;
            padding: 8px 15px;
            border-radius: 5px;
            display: inline-block;
            margin-top: 10px;
            border-left: 3px solid var(--secondary-color);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }
        
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background-color: white;
            border-radius: 10px;
            box-shadow: var(--shadow);
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .card-title {
            font-size: 20px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-title i {
            color: var(--secondary-color);
        }
        
        .input-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .input-section {
                grid-template-columns: 1fr;
            }
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .input-with-unit {
            position: relative;
        }
        
        .unit {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }
        
        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--secondary-color);
        }
        
        input[type="range"] {
            padding: 0;
        }
        
        .range-value {
            display: inline-block;
            margin-left: 10px;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .fixed-opex-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        
        .kpi-card {
            background-color: var(--light-bg);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            border-top: 4px solid var(--secondary-color);
        }
        
        .kpi-card.warning {
            border-top-color: var(--warning-color);
        }
        
        .kpi-card.danger {
            border-top-color: var(--danger-color);
        }
        
        .kpi-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-color);
            margin: 10px 0;
        }
        
        .kpi-label {
            font-size: 14px;
            color: var(--text-light);
        }
        
        .kpi-subtext {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 5px;
        }
        
        .financial-breakdown {
            margin-top: 25px;
        }
        
        .breakdown-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .breakdown-row.total {
            font-weight: 700;
            border-top: 2px solid var(--primary-color);
            border-bottom: none;
            padding-top: 15px;
            margin-top: 10px;
        }
        
        .breakdown-row.highlight {
            background-color: rgba(45, 116, 218, 0.05);
            padding-left: 10px;
            padding-right: 10px;
            margin-left: -10px;
            margin-right: -10px;
            border-radius: 5px;
        }
        
        .chart-container {
            height: 300px;
            margin-top: 20px;
            position: relative;
        }
        
        .insight-box {
            background-color: rgba(13, 155, 108, 0.1);
            border-left: 4px solid var(--accent-color);
            padding: 15px;
            margin-top: 20px;
            border-radius: 0 5px 5px 0;
        }
        
        .insight-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .alert {
            background-color: rgba(213, 90, 11, 0.1);
            border-left: 4px solid var(--warning-color);
            padding: 15px;
            margin-top: 20px;
            border-radius: 0 5px 5px 0;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-light);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--secondary-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .formula-note {
            font-size: 13px;
            color: var(--text-light);
            font-style: italic;
            margin-top: 5px;
        }
        
        .footer-note {
            text-align: center;
            padding: 20px;
            color: var(--text-light);
            font-size: 14px;
            margin-top: 30px;
            border-top: 1px solid var(--border-color);
        }
        
        .risk-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 5px;
            font-size: 14px;
        }
        
        .risk-indicator.warning {
            color: var(--warning-color);
        }
        
        .risk-indicator.danger {
            color: var(--danger-color);
        }
        
        button {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: var(--primary-color);
        }
        
        .export-btn {
            background-color: var(--accent-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-section">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div>
                        <h1>Tribe <span>Finance OS</span></h1>
                        <p class="subtitle">EBITDA Calculator with Revenue-Share Model | Multi-Property Accommodation Business</p>
                    </div>
                </div>
                <div class="finance-model">
                    <i class="fas fa-file-contract"></i> Operating Model: 5% Base + 10% EBITDA Share
                </div>
            </div>
        </header>
        
        <div class="main-content">
            <!-- Left Column: Inputs and KPIs -->
            <div class="left-column">
                <!-- Core Inputs -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-calculator"></i> Core Financial Inputs (Monthly)</h2>
                        <div class="range-value" id="occupancyValue">75%</div>
                    </div>
                    
                    <div class="input-section">
                        <div class="input-group">
                            <label for="totalBeds"><i class="fas fa-bed"></i> Total Beds</label>
                            <input type="number" id="totalBeds" min="1" value="120">
                        </div>
                        
                        <div class="input-group">
                            <label for="occupancy"><i class="fas fa-percentage"></i> Occupancy %</label>
                            <input type="range" id="occupancy" min="0" max="100" step="1" value="75">
                            <div class="range-value" id="occupancyValueDisplay">75%</div>
                        </div>
                        
                        <div class="input-group">
                            <label for="revenuePerBed"><i class="fas fa-rupee-sign"></i> Revenue per Bed</label>
                            <div class="input-with-unit">
                                <input type="number" id="revenuePerBed" min="0" value="8500">
                                <span class="unit">₹</span>
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <label for="variableOpex"><i class="fas fa-chart-pie"></i> Variable OPEX (% of Revenue)</label>
                            <div class="input-with-unit">
                                <input type="number" id="variableOpex" min="0" max="100" step="0.1" value="12.5">
                                <span class="unit">%</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Fixed OPEX Inputs -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-tools"></i> Fixed OPEX - Utilities & Operations</h2>
                        <small>Fixed monthly costs (do not change with occupancy)</small>
                    </div>
                    
                    <div class="fixed-opex-grid">
                        <div class="input-group">
                            <label for="electricity"><i class="fas fa-bolt"></i> Electricity</label>
                            <div class="input-with-unit">
                                <input type="number" id="electricity" min="0" value="45000">
                                <span class="unit">₹</span>
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <label for="food"><i class="fas fa-utensils"></i> Food</label>
                            <div class="input-with-unit">
                                <input type="number" id="food" min="0" value="65000">
                                <span class="unit">₹</span>
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <label for="housekeeping"><i class="fas fa-broom"></i> Housekeeping & Utilities</label>
                            <div class="input-with-unit">
                                <input type="number" id="housekeeping" min="0" value="32000">
                                <span class="unit">₹</span>
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <label for="maintenance"><i class="fas fa-hard-hat"></i> Building Repair & Maintenance</label>
                            <div class="input-with-unit">
                                <input type="number" id="maintenance" min="0" value="28000">
                                <span class="unit">₹</span>
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <label for="rent"><i class="fas fa-building"></i> Rent</label>
                            <div class="input-with-unit">
                                <input type="number" id="rent" min="0" value="120000">
                                <span class="unit">₹</span>
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <label for="laundry"><i class="fas fa-tshirt"></i> Laundry</label>
                            <div class="input-with-unit">
                                <input type="number" id="laundry" min="0" value="18000">
                                <span class="unit">₹</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="formula-note">
                        <i class="fas fa-info-circle"></i> Fixed OPEX = Sum of all above (Electricity + Food + Housekeeping + Maintenance + Rent + Laundry)
                    </div>
                </div>
                
                <!-- Other Financial Inputs -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-file-invoice-dollar"></i> Other Financial Inputs</h2>
                    </div>
                    
                    <div class="input-section">
                        <div class="input-group">
                            <label for="depreciation"><i class="fas fa-chart-line-down"></i> Depreciation</label>
                            <div class="input-with-unit">
                                <input type="number" id="depreciation" min="0" value="35000">
                                <span class="unit">₹</span>
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <label for="interest"><i class="fas fa-percentage"></i> Interest Cost</label>
                            <div class="input-with-unit">
                                <input type="number" id="interest" min="0" value="25000">
                                <span class="unit">₹</span>
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <label for="tax"><i class="fas fa-landmark"></i> Tax Rate</label>
                            <div class="input-with-unit">
                                <input type="number" id="tax" min="0" max="100" step="0.1" value="25">
                                <span class="unit">%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Results and Visualizations -->
            <div class="right-column">
                <!-- KPIs -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-tachometer-alt"></i> Core KPIs & Performance Metrics</h2>
                    </div>
                    
                    <div class="kpi-grid" id="kpiGrid">
                        <!-- KPIs will be populated by JavaScript -->
                    </div>
                    
                    <!-- Financial Breakdown -->
                    <div class="financial-breakdown">
                        <h3 style="margin-bottom: 15px; color: var(--primary-color);">Financial Breakdown</h3>
                        
                        <div class="breakdown-row">
                            <span>Revenue</span>
                            <span id="revenueValue">₹0</span>
                        </div>
                        
                        <div class="breakdown-row">
                            <span>Total Fixed OPEX</span>
                            <span id="fixedOpexValue">₹0</span>
                        </div>
                        
                        <div class="breakdown-row">
                            <span>Variable OPEX</span>
                            <span id="variableOpexValue">₹0</span>
                        </div>
                        
                        <div class="breakdown-row">
                            <span>Total OPEX</span>
                            <span id="totalOpexValue">₹0</span>
                        </div>
                        
                        <div class="breakdown-row total">
                            <span>EBITDA</span>
                            <span id="ebitdaValue">₹0</span>
                        </div>
                        
                        <div class="breakdown-row">
                            <span>Depreciation</span>
                            <span id="depreciationValue">₹0</span>
                        </div>
                        
                        <div class="breakdown-row">
                            <span>Interest</span>
                            <span id="interestValue">₹0</span>
                        </div>
                        
                        <div class="breakdown-row">
                            <span>Tax</span>
                            <span id="taxValue">₹0</span>
                        </div>
                        
                        <div class="breakdown-row total">
                            <span>PAT (Profit After Tax)</span>
                            <span id="patValue">₹0</span>
                        </div>
                    </div>
                </div>
                
                <!-- Revenue Share Model -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-handshake"></i> Revenue-Share Contract Economics</h2>
                    </div>
                    
                    <div class="tabs">
                        <div class="tab active" onclick="switchTab('tribe')">Tribe Earnings</div>
                        <div class="tab" onclick="switchTab('builder')">Builder Share</div>
                        <div class="tab" onclick="switchTab('effective')">Effective Rates</div>
                    </div>
                    
                    <!-- Tribe Earnings Tab -->
                    <div id="tribeTab" class="tab-content active">
                        <div class="breakdown-row highlight">
                            <span>Tribe Base Fee (5% of Revenue)</span>
                            <span id="tribeBaseFee">₹0</span>
                        </div>
                        
                        <div class="breakdown-row">
                            <span>Adjusted EBITDA (EBITDA - Base Fee)</span>
                            <span id="adjustedEbitda">₹0</span>
                        </div>
                        
                        <div class="breakdown-row">
                            <span>Tribe EBITDA Incentive (10% of Adj. EBITDA if positive)</span>
                            <span id="tribeIncentive">₹0</span>
                        </div>
                        
                        <div class="breakdown-row total">
                            <span>Tribe Total Earnings</span>
                            <span id="tribeTotal">₹0</span>
                        </div>
                        
                        <div class="kpi-card" style="margin-top: 20px;">
                            <div class="kpi-label">Tribe Earnings per Bed</div>
                            <div class="kpi-value" id="tribePerBed">₹0</div>
                        </div>
                    </div>
                    
                    <!-- Builder Share Tab -->
                    <div id="builderTab" class="tab-content">
                        <div class="breakdown-row">
                            <span>Revenue</span>
                            <span id="builderRevenue">₹0</span>
                        </div>
                        
                        <div class="breakdown-row">
                            <span>Total OPEX</span>
                            <span id="builderOpex">₹0</span>
                        </div>
                        
                        <div class="breakdown-row">
                            <span>Tribe Total Earnings</span>
                            <span id="builderTribeEarnings">₹0</span>
                        </div>
                        
                        <div class="breakdown-row total">
                            <span>Builder Share (Revenue - OPEX - Tribe Earnings)</span>
                            <span id="builderShare">₹0</span>
                        </div>
                        
                        <div class="insight-box" id="builderInsight">
                            <div class="insight-header">
                                <i class="fas fa-lightbulb"></i>
                                <h4>Insight</h4>
                            </div>
                            <p>The builder receives the remaining surplus after all operational costs and Tribe's share. If EBITDA is negative, the builder absorbs the loss.</p>
                        </div>
                    </div>
                    
                    <!-- Effective Rates Tab -->
                    <div id="effectiveTab" class="tab-content">
                        <div class="breakdown-row">
                            <span>Effective Tribe Take Rate</span>
                            <span id="effectiveTribeRate">0%</span>
                        </div>
                        
                        <div class="breakdown-row">
                            <span>Builder's Effective Share of Revenue</span>
                            <span id="effectiveBuilderRate">0%</span>
                        </div>
                        
                        <div class="breakdown-row">
                            <span>OPEX as % of Revenue</span>
                            <span id="opexRate">0%</span>
                        </div>
                        
                        <div class="breakdown-row">
                            <span>EBITDA Margin</span>
                            <span id="ebitdaMargin">0%</span>
                        </div>
                        
                        <div class="breakdown-row">
                            <span>PAT Margin</span>
                            <span id="patMargin">0%</span>
                        </div>
                    </div>
                </div>
                
                <!-- Charts Section -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-chart-bar"></i> Financial Visualizations</h2>
                        <button class="export-btn" onclick="exportData()"><i class="fas fa-download"></i> Export Data</button>
                    </div>
                    
                    <div class="tabs">
                        <div class="tab active" onclick="switchChart('revenueChart')">Revenue vs OPEX vs EBITDA</div>
                        <div class="tab" onclick="switchChart('fixedOpexChart')">Fixed OPEX Breakdown</div>
                        <div class="tab" onclick="switchChart('revenueShareChart')">Revenue Split</div>
                        <div class="tab" onclick="switchChart('sensitivityChart')">Occupancy Sensitivity</div>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="revenueChart" class="chart-canvas active"></canvas>
                        <canvas id="fixedOpexChart" class="chart-canvas"></canvas>
                        <canvas id="revenueShareChart" class="chart-canvas"></canvas>
                        <canvas id="sensitivityChart" class="chart-canvas"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Risk Indicators & Insights -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title"><i class="fas fa-exclamation-triangle"></i> Risk Indicators & Strategic Insights</h2>
            </div>
            
            <div id="riskIndicators">
                <!-- Risk indicators will be populated by JavaScript -->
            </div>
            
            <div id="insightsContainer" style="margin-top: 20px;">
                <!-- Insights will be populated by JavaScript -->
            </div>
        </div>
        
        <div class="footer-note">
            <p><i class="fas fa-lock"></i> Tribe Finance OS v2.1 | EBITDA-Accurate Revenue-Share Model | Designed for Internal Decision-Making</p>
            <p style="margin-top: 5px; font-size: 12px;">This system follows real accounting logic and is auditable. All calculations are explicitly defined for finance team verification.</p>
        </div>
    </div>

    <script>
        // DOM Elements
        const totalBedsInput = document.getElementById('totalBeds');
        const occupancyInput = document.getElementById('occupancy');
        const revenuePerBedInput = document.getElementById('revenuePerBed');
        const variableOpexInput = document.getElementById('variableOpex');
        
        // Fixed OPEX inputs
        const electricityInput = document.getElementById('electricity');
        const foodInput = document.getElementById('food');
        const housekeepingInput = document.getElementById('housekeeping');
        const maintenanceInput = document.getElementById('maintenance');
        const rentInput = document.getElementById('rent');
        const laundryInput = document.getElementById('laundry');
        
        // Other inputs
        const depreciationInput = document.getElementById('depreciation');
        const interestInput = document.getElementById('interest');
        const taxInput = document.getElementById('tax');
        
        // Chart variables
        let revenueChartInstance, fixedOpexChartInstance, revenueShareChartInstance, sensitivityChartInstance;
        let activeChart = 'revenueChart';
        let calculationTimeout;
        
        // Debounced calculation function to prevent rapid updates
        function debouncedCalculateFinance() {
            clearTimeout(calculationTimeout);
            calculationTimeout = setTimeout(calculateFinance, 150);
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Add global error handler for unhandled promise rejections
            window.addEventListener('unhandledrejection', function(event) {
                console.warn('Unhandled promise rejection:', event.reason);
                event.preventDefault(); // Prevent the error from showing in console
            });
            
            // Add global error handler
            window.addEventListener('error', function(event) {
                console.warn('Global error:', event.error);
            });
            
            // Set up event listeners for all inputs
            const allInputs = document.querySelectorAll('input');
            allInputs.forEach(input => {
                input.addEventListener('input', debouncedCalculateFinance);
            });
            
            // Set up occupancy slider display
            occupancyInput.addEventListener('input', function() {
                document.getElementById('occupancyValue').textContent = this.value + '%';
                document.getElementById('occupancyValueDisplay').textContent = this.value + '%';
            });
            
            // Initialize calculations
            calculateFinance();
        });
        
        // Main calculation function
        function calculateFinance() {
            // Validate inputs
            validateInputs();
            
            // STEP 1: Core Operations Calculations
            const totalBeds = parseFloat(totalBedsInput.value) || 0;
            const occupancy = parseFloat(occupancyInput.value) || 0;
            const revenuePerBed = parseFloat(revenuePerBedInput.value) || 0;
            const variableOpexPercent = parseFloat(variableOpexInput.value) || 0;
            
            // Occupied beds calculation
            const occupiedBeds = totalBeds * (occupancy / 100);
            
            // Revenue calculation
            const revenue = occupiedBeds * revenuePerBed;
            
            // STEP 2: Fixed OPEX Calculation
            const electricity = parseFloat(electricityInput.value) || 0;
            const food = parseFloat(foodInput.value) || 0;
            const housekeeping = parseFloat(housekeepingInput.value) || 0;
            const maintenance = parseFloat(maintenanceInput.value) || 0;
            const rent = parseFloat(rentInput.value) || 0;
            const laundry = parseFloat(laundryInput.value) || 0;
            
            const totalFixedOpex = electricity + food + housekeeping + maintenance + rent + laundry;
            
            // STEP 3: Variable OPEX Calculation
            const variableOpex = revenue * (variableOpexPercent / 100);
            
            // STEP 4: Total OPEX and EBITDA
            const totalOpex = totalFixedOpex + variableOpex;
            const ebitda = revenue - totalOpex;
            
            // STEP 5: Revenue-Share Model Calculations
            // Tribe Base Fee = 5% of Gross Revenue
            const tribeBaseFee = revenue * 0.05;
            
            // Adjusted EBITDA = EBITDA - Tribe Base Fee
            const adjustedEbitda = ebitda - tribeBaseFee;
            
            // Tribe EBITDA Incentive = 10% of Adjusted EBITDA (only if positive)
            let tribeEbitdaIncentive = 0;
            if (adjustedEbitda > 0) {
                tribeEbitdaIncentive = adjustedEbitda * 0.10;
            }
            
            // Tribe Total Earnings
            const tribeTotalEarnings = tribeBaseFee + tribeEbitdaIncentive;
            
            // Builder Share = Adjusted EBITDA - Tribe EBITDA Incentive
            const builderShare = adjustedEbitda - tribeEbitdaIncentive;
            
            // STEP 6: Post-EBITDA Calculations
            const depreciation = parseFloat(depreciationInput.value) || 0;
            const interest = parseFloat(interestInput.value) || 0;
            const taxRate = parseFloat(taxInput.value) || 0;
            
            const pbt = ebitda - depreciation - interest;
            const tax = Math.max(0, pbt * (taxRate / 100));
            const pat = pbt - tax;
            
            // STEP 7: KPIs and Metrics
            const ebitdaPerBed = totalBeds > 0 ? ebitda / totalBeds : 0;
            const fixedOpexPerBed = totalBeds > 0 ? totalFixedOpex / totalBeds : 0;
            const fixedOpexPercentOfRevenue = revenue > 0 ? (totalFixedOpex / revenue) * 100 : 0;
            const tribeEarningsPerBed = totalBeds > 0 ? tribeTotalEarnings / totalBeds : 0;
            
            // Effective rates
            const effectiveTribeRate = revenue > 0 ? (tribeTotalEarnings / revenue) * 100 : 0;
            const effectiveBuilderRate = revenue > 0 ? (builderShare / revenue) * 100 : 0;
            const opexRate = revenue > 0 ? (totalOpex / revenue) * 100 : 0;
            const ebitdaMargin = revenue > 0 ? (ebitda / revenue) * 100 : 0;
            const patMargin = revenue > 0 ? (pat / revenue) * 100 : 0;
            
            // Update UI with calculated values
            updateUI(revenue, totalFixedOpex, variableOpex, totalOpex, ebitda, 
                     depreciation, interest, tax, pat, tribeBaseFee, adjustedEbitda, 
                     tribeEbitdaIncentive, tribeTotalEarnings, builderShare, ebitdaPerBed, 
                     fixedOpexPerBed, fixedOpexPercentOfRevenue, tribeEarningsPerBed,
                     effectiveTribeRate, effectiveBuilderRate, opexRate, ebitdaMargin, patMargin);
            
            // Update KPIs
            updateKPIs(revenue, ebitda, pat, ebitdaPerBed, totalFixedOpex, fixedOpexPerBed);
            
            // Update risk indicators and insights
            updateRiskIndicators(ebitda, pat, fixedOpexPercentOfRevenue);
            updateInsights(ebitda, pat, tribeTotalEarnings, builderShare, occupancy, totalBeds);
            
            // Update charts
            updateCharts(revenue, totalFixedOpex, variableOpex, ebitda, electricity, food, 
                        housekeeping, maintenance, rent, laundry, tribeTotalEarnings, 
                        builderShare, occupancy, totalBeds, revenuePerBed, variableOpexPercent);
        }
        
        // Validate inputs to prevent negative values
        function validateInputs() {
            const inputs = [
                totalBedsInput, revenuePerBedInput, variableOpexInput,
                electricityInput, foodInput, housekeepingInput, 
                maintenanceInput, rentInput, laundryInput,
                depreciationInput, interestInput, taxInput
            ];
            
            inputs.forEach(input => {
                if (parseFloat(input.value) < 0) {
                    input.value = 0;
                }
            });
            
            // Ensure occupancy is between 0 and 100
            if (parseFloat(occupancyInput.value) < 0) {
                occupancyInput.value = 0;
            } else if (parseFloat(occupancyInput.value) > 100) {
                occupancyInput.value = 100;
            }
            
            // Ensure tax is between 0 and 100
            if (parseFloat(taxInput.value) < 0) {
                taxInput.value = 0;
            } else if (parseFloat(taxInput.value) > 100) {
                taxInput.value = 100;
            }
        }
        
        // Update UI with calculated values
        function updateUI(revenue, totalFixedOpex, variableOpex, totalOpex, ebitda, 
                         depreciation, interest, tax, pat, tribeBaseFee, adjustedEbitda, 
                         tribeEbitdaIncentive, tribeTotalEarnings, builderShare, ebitdaPerBed, 
                         fixedOpexPerBed, fixedOpexPercentOfRevenue, tribeEarningsPerBed,
                         effectiveTribeRate, effectiveBuilderRate, opexRate, ebitdaMargin, patMargin) {
            
            // Format currency values
            const formatCurrency = (value) => {
                return new Intl.NumberFormat('en-IN', {
                    style: 'currency',
                    currency: 'INR',
                    maximumFractionDigits: 0
                }).format(value);
            };
            
            const formatPercent = (value) => {
                return value.toFixed(2) + '%';
            };
            
            // Update financial breakdown
            document.getElementById('revenueValue').textContent = formatCurrency(revenue);
            document.getElementById('fixedOpexValue').textContent = formatCurrency(totalFixedOpex);
            document.getElementById('variableOpexValue').textContent = formatCurrency(variableOpex);
            document.getElementById('totalOpexValue').textContent = formatCurrency(totalOpex);
            document.getElementById('ebitdaValue').textContent = formatCurrency(ebitda);
            document.getElementById('depreciationValue').textContent = formatCurrency(depreciation);
            document.getElementById('interestValue').textContent = formatCurrency(interest);
            document.getElementById('taxValue').textContent = formatCurrency(tax);
            document.getElementById('patValue').textContent = formatCurrency(pat);
            
            // Update revenue share model
            document.getElementById('tribeBaseFee').textContent = formatCurrency(tribeBaseFee);
            document.getElementById('adjustedEbitda').textContent = formatCurrency(adjustedEbitda);
            document.getElementById('tribeIncentive').textContent = formatCurrency(tribeEbitdaIncentive);
            document.getElementById('tribeTotal').textContent = formatCurrency(tribeTotalEarnings);
            document.getElementById('tribePerBed').textContent = formatCurrency(tribeEarningsPerBed);
            
            // Update builder share tab
            document.getElementById('builderRevenue').textContent = formatCurrency(revenue);
            document.getElementById('builderOpex').textContent = formatCurrency(totalOpex);
            document.getElementById('builderTribeEarnings').textContent = formatCurrency(tribeTotalEarnings);
            document.getElementById('builderShare').textContent = formatCurrency(builderShare);
            
            // Update effective rates tab
            document.getElementById('effectiveTribeRate').textContent = formatPercent(effectiveTribeRate);
            document.getElementById('effectiveBuilderRate').textContent = formatPercent(effectiveBuilderRate);
            document.getElementById('opexRate').textContent = formatPercent(opexRate);
            document.getElementById('ebitdaMargin').textContent = formatPercent(ebitdaMargin);
            document.getElementById('patMargin').textContent = formatPercent(patMargin);
        }
        
        // Update KPIs
        function updateKPIs(revenue, ebitda, pat, ebitdaPerBed, totalFixedOpex, fixedOpexPerBed) {
            const formatCurrency = (value) => {
                return new Intl.NumberFormat('en-IN', {
                    style: 'currency',
                    currency: 'INR',
                    maximumFractionDigits: 0
                }).format(value);
            };
            
            const kpiGrid = document.getElementById('kpiGrid');
            kpiGrid.innerHTML = `
                <div class="kpi-card">
                    <div class="kpi-label">Revenue</div>
                    <div class="kpi-value">${formatCurrency(revenue)}</div>
                    <div class="kpi-subtext">Monthly</div>
                </div>
                <div class="kpi-card ${ebitda < 0 ? 'danger' : ''}">
                    <div class="kpi-label">EBITDA</div>
                    <div class="kpi-value">${formatCurrency(ebitda)}</div>
                    <div class="kpi-subtext">Operating Profit</div>
                </div>
                <div class="kpi-card ${pat < 0 ? 'danger' : ''}">
                    <div class="kpi-label">PAT</div>
                    <div class="kpi-value">${formatCurrency(pat)}</div>
                    <div class="kpi-subtext">Profit After Tax</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">EBITDA per Bed</div>
                    <div class="kpi-value">${formatCurrency(ebitdaPerBed)}</div>
                    <div class="kpi-subtext">Monthly</div>
                </div>
                <div class="kpi-card ${totalFixedOpex > revenue * 0.4 ? 'warning' : ''}">
                    <div class="kpi-label">Fixed OPEX</div>
                    <div class="kpi-value">${formatCurrency(totalFixedOpex)}</div>
                    <div class="kpi-subtext">Utilities & Operations</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Fixed OPEX per Bed</div>
                    <div class="kpi-value">${formatCurrency(fixedOpexPerBed)}</div>
                    <div class="kpi-subtext">Monthly</div>
                </div>
            `;
        }
        
        // Update risk indicators
        function updateRiskIndicators(ebitda, pat, fixedOpexPercentOfRevenue) {
            const riskIndicators = document.getElementById('riskIndicators');
            let riskHTML = '';
            
            if (ebitda < 0) {
                riskHTML += `
                    <div class="alert">
                        <div class="risk-indicator danger">
                            <i class="fas fa-exclamation-circle"></i>
                            <strong>Negative EBITDA Warning:</strong> Operating at a loss before depreciation, interest, and taxes.
                        </div>
                    </div>
                `;
            }
            
            if (pat < 0) {
                riskHTML += `
                    <div class="alert">
                        <div class="risk-indicator danger">
                            <i class="fas fa-exclamation-circle"></i>
                            <strong>Negative PAT Warning:</strong> Business is generating net losses after all expenses and taxes.
                        </div>
                    </div>
                `;
            }
            
            if (fixedOpexPercentOfRevenue > 40) {
                riskHTML += `
                    <div class="alert">
                        <div class="risk-indicator warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>High Fixed-Cost Alert:</strong> Fixed OPEX exceeds 40% of revenue, indicating high operational leverage.
                        </div>
                    </div>
                `;
            }
            
            if (riskHTML === '') {
                riskHTML = `
                    <div class="insight-box">
                        <div class="insight-header">
                            <i class="fas fa-check-circle"></i>
                            <h4>All Systems Normal</h4>
                        </div>
                        <p>No critical risk indicators detected. Current financial metrics are within acceptable ranges.</p>
                    </div>
                `;
            }
            
            riskIndicators.innerHTML = riskHTML;
        }
        
        // Update strategic insights
        function updateInsights(ebitda, pat, tribeTotalEarnings, builderShare, occupancy, totalBeds) {
            const insightsContainer = document.getElementById('insightsContainer');
            
            let insights = [];
            
            // Insight based on EBITDA
            if (ebitda < 0) {
                insights.push("Consider reducing fixed costs or increasing occupancy to achieve positive EBITDA.");
            } else if (ebitda > 0 && pat < 0) {
                insights.push("Business is operationally profitable but net losses are due to high depreciation, interest, or taxes.");
            }
            
            // Insight based on occupancy
            if (occupancy < 60) {
                insights.push("Low occupancy (<60%) suggests need for marketing initiatives or pricing strategy review.");
            } else if (occupancy > 90) {
                insights.push("High occupancy (>90%) indicates potential for price optimization or capacity expansion.");
            }
            
            // Insight based on Tribe vs Builder share
            if (tribeTotalEarnings > builderShare && builderShare > 0) {
                insights.push("Tribe earnings exceed builder share. Consider contract renegotiation if sustainable.");
            } else if (builderShare < 0) {
                insights.push("Builder is absorbing losses. Review operating model sustainability.");
            }
            
            // Insight based on scale
            if (totalBeds < 50) {
                insights.push("Small property scale may limit economies of scale. Consider portfolio expansion.");
            }
            
            // If no specific insights, provide general guidance
            if (insights.length === 0) {
                insights.push("Financial performance appears stable. Focus on incremental improvements in occupancy and cost control.");
                insights.push("Consider sensitivity analysis to understand impact of occupancy changes on profitability.");
            }
            
            let insightsHTML = '<div class="insight-box"><div class="insight-header"><i class="fas fa-lightbulb"></i><h4>Strategic Insights for Leadership</h4></div><ul style="margin-left: 20px; margin-top: 10px;">';
            
            insights.forEach(insight => {
                insightsHTML += `<li style="margin-bottom: 8px;">${insight}</li>`;
            });
            
            insightsHTML += '</ul></div>';
            
            insightsContainer.innerHTML = insightsHTML;
        }
        
        // Update all charts
        function updateCharts(revenue, totalFixedOpex, variableOpex, ebitda, electricity, food, 
                             housekeeping, maintenance, rent, laundry, tribeTotalEarnings, 
                             builderShare, occupancy, totalBeds, revenuePerBed, variableOpexPercent) {
            
            // Destroy existing charts if they exist
            try {
                if (revenueChartInstance) revenueChartInstance.destroy();
                if (fixedOpexChartInstance) fixedOpexChartInstance.destroy();
                if (revenueShareChartInstance) revenueShareChartInstance.destroy();
                if (sensitivityChartInstance) sensitivityChartInstance.destroy();
            } catch (error) {
                console.warn('Error destroying charts:', error);
            }
            
            // Create Revenue vs OPEX vs EBITDA chart
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            revenueChartInstance = new Chart(revenueCtx, {
                type: 'bar',
                data: {
                    labels: ['Revenue', 'Total OPEX', 'EBITDA'],
                    datasets: [{
                        label: 'Amount (₹)',
                        data: [revenue, totalFixedOpex + variableOpex, ebitda],
                        backgroundColor: [
                            'rgba(45, 116, 218, 0.7)',
                            'rgba(213, 90, 11, 0.7)',
                            'rgba(13, 155, 108, 0.7)'
                        ],
                        borderColor: [
                            'rgb(45, 116, 218)',
                            'rgb(213, 90, 11)',
                            'rgb(13, 155, 108)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Revenue vs OPEX vs EBITDA',
                            font: { size: 16 }
                        },
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '₹' + (value / 1000).toFixed(0) + 'K';
                                }
                            }
                        }
                    }
                }
            });
            
            // Create Fixed OPEX Breakdown chart
            const fixedOpexCtx = document.getElementById('fixedOpexChart').getContext('2d');
            fixedOpexChartInstance = new Chart(fixedOpexCtx, {
                type: 'bar',
                data: {
                    labels: ['Electricity', 'Food', 'Housekeeping', 'Maintenance', 'Rent', 'Laundry'],
                    datasets: [{
                        label: 'Amount (₹)',
                        data: [electricity, food, housekeeping, maintenance, rent, laundry],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(153, 102, 255, 0.7)',
                            'rgba(255, 159, 64, 0.7)'
                        ],
                        borderColor: [
                            'rgb(255, 99, 132)',
                            'rgb(54, 162, 235)',
                            'rgb(255, 206, 86)',
                            'rgb(75, 192, 192)',
                            'rgb(153, 102, 255)',
                            'rgb(255, 159, 64)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Fixed OPEX Category Breakdown',
                            font: { size: 16 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '₹' + (value / 1000).toFixed(0) + 'K';
                                }
                            }
                        }
                    }
                }
            });
            
            // Create Revenue Split chart
            const revenueShareCtx = document.getElementById('revenueShareChart').getContext('2d');
            revenueShareChartInstance = new Chart(revenueShareCtx, {
                type: 'pie',
                data: {
                    labels: ['Tribe Earnings', 'Builder Share', 'OPEX'],
                    datasets: [{
                        data: [tribeTotalEarnings, builderShare, totalFixedOpex + variableOpex],
                        backgroundColor: [
                            'rgba(13, 155, 108, 0.7)',
                            'rgba(45, 116, 218, 0.7)',
                            'rgba(213, 90, 11, 0.7)'
                        ],
                        borderColor: [
                            'rgb(13, 155, 108)',
                            'rgb(45, 116, 218)',
                            'rgb(213, 90, 11)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Revenue Split: Tribe vs Builder vs OPEX',
                            font: { size: 16 }
                        },
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
            
            // Create Occupancy Sensitivity chart
            const sensitivityCtx = document.getElementById('sensitivityChart').getContext('2d');
            
            // Generate data for sensitivity analysis (EBITDA at different occupancy levels)
            const occupancyLevels = [];
            const ebitdaLevels = [];
            
            for (let occ = 10; occ <= 100; occ += 10) {
                occupancyLevels.push(occ + '%');
                
                // Calculate EBITDA at this occupancy level
                const occupiedBeds = totalBeds * (occ / 100);
                const revenueAtOcc = occupiedBeds * revenuePerBed;
                const variableOpexAtOcc = revenueAtOcc * (variableOpexPercent / 100);
                const totalOpexAtOcc = totalFixedOpex + variableOpexAtOcc;
                const ebitdaAtOcc = revenueAtOcc - totalOpexAtOcc;
                
                ebitdaLevels.push(ebitdaAtOcc);
            }
            
            sensitivityChartInstance = new Chart(sensitivityCtx, {
                type: 'line',
                data: {
                    labels: occupancyLevels,
                    datasets: [{
                        label: 'EBITDA (₹)',
                        data: ebitdaLevels,
                        backgroundColor: 'rgba(13, 155, 108, 0.1)',
                        borderColor: 'rgb(13, 155, 108)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'EBITDA Sensitivity to Occupancy %',
                            font: { size: 16 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '₹' + (value / 1000).toFixed(0) + 'K';
                                }
                            }
                        }
                    }
                }
            });
            
            // Show the active chart
            showActiveChart();
        }
        
        // Switch between tabs in revenue share section
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Activate selected tab
            event.target.classList.add('active');
        }
        
        // Switch between charts
        function switchChart(chartName) {
            activeChart = chartName;
            showActiveChart();
            
            // Update tab styles
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
        }
        
        // Show the active chart
        function showActiveChart() {
            // Hide all charts
            document.querySelectorAll('.chart-canvas').forEach(chart => {
                chart.classList.remove('active');
            });
            
            // Show active chart
            document.getElementById(activeChart).classList.add('active');
        }
        
        // Export data function
        function exportData() {
            // In a real system, this would export to CSV or PDF
            alert('Export functionality would generate a PDF/CSV report in a production system.\n\nIn this demo, all data is visible on screen and calculations are transparent for audit purposes.');
        }
    </script>
</body>
</html>